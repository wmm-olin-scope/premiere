// Generated by CoffeeScript 1.6.3
var contentDiv, countdownLength, getCookie, movieDone, movieStart, setupCategory, startCountdownBar, startMovie, startMovieCheck, startPartnerVideo, startPostshow, startPreshow, switchContent, transition, userCategory;

contentDiv = $("#content");

movieStart = Date.now() + 2 * 60 * 1000;

movieDone = movieStart + 30 * 1000;

countdownLength = 2 * 60 * 1000;

userCategory = "General";

switchContent = function(contentUrl, done) {
  if (done == null) {
    done = null;
  }
  return $.ajax(contentUrl).fail(function(err) {
    return console.log(err);
  }).done(function(content) {
    contentDiv.html(content);
    if (done) {
      return done();
    }
  });
};

transition = function(request, title, duration) {
  var progressBar, progressWindow;
  if (title == null) {
    title = null;
  }
  if (duration == null) {
    duration = 750;
  }
  $("body").append("<div id=\"progress-window\">\n    <div id=\"progress-bar\"></div>\n</div>");
  progressWindow = $("#progress-window");
  progressBar = $("#progress-bar", progressWindow);
  progressWindow.dialog({
    dialogClass: "dialog-no-close",
    width: 600,
    height: 102,
    modal: true,
    resizable: false,
    draggable: false,
    closeOnEscape: false
  });
  if (title) {
    progressWindow.dialog("option", "title", title);
  } else {
    $(".ui-dialog-titlebar", progressWindow.parent()).css("display", "none");
  }
  progressWindow.dialog("open");
  progressBar.progressbar({
    value: false
  });
  return request.always(function() {
    progressBar.progressbar({
      value: 1
    });
    return $(".ui-progressbar-value", progressBar).animate({
      width: "100%"
    }, {
      duration: duration,
      complete: function() {
        progressWindow.dialog("close");
        return progressWindow.parent().remove();
      }
    });
  });
};

getCookie = function(name) {
  var re, result;
  re = new RegExp("(?:^" + name + "|;\s*" + name + ")=(.*?)(?:;|$)", "g");
  result = re.exec(document.cookie);
  if (result) {
    return result[1];
  } else {
    return null;
  }
};

startPartnerVideo = function(category) {
  var req;
  req = switchContent("/premiere/partner", function() {
    return new YT.Player('partner-video-iframe', {
      height: '550',
      width: '960',
      videoId: 'kaoGnuhz4Kg',
      allowfullscreen: true,
      frameborder: "no",
      autoplay: true,
      events: {
        onReady: function(event) {
          return event.target.playVideo();
        },
        onStateChange: function(event) {
          if (event.data === YT.PlayerState.ENDED) {
            return startPreshow(category);
          }
        }
      }
    });
  });
  return transition(req, "Loading a message from Randi");
};

startPreshow = function(category) {
  var req;
  if (category == null) {
    category = "General";
  }
  console.log("Preshow starting");
  req = switchContent("/premiere/preshow/" + category, function() {
    console.log("Preshow loaded");
    startCountdownBar();
    return startMovieCheck();
  });
  return transition(req);
};

setupCategory = function() {
  var category, onClickCategory;
  onClickCategory = function(category) {
    category = "Student";
    movieStart = Date.now() + 1.5 * 60 * 1000;
    userCategory = category;
    return startPartnerVideo(category);
  };
  category = null;
  if (category !== null) {
    return onClickCategory(category);
  } else {
    return switchContent("/premiere/category", function() {
      var _i, _len, _ref, _results;
      _ref = ["General", "Student", "Parent", "Educator"];
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        category = _ref[_i];
        _results.push((function(category) {
          return $("button#" + category).on("click", function() {
            return onClickCategory(category);
          });
        })(category));
      }
      return _results;
    });
  }
};

startCountdownBar = function() {
  var bar, delta, div, id, width;
  bar = $("#countdown-bar");
  delta = movieStart - Date.now();
  countdownLength = delta + 1000;
  if (delta > countdownLength) {
    div = $("countdown");
    div.hide();
    setTimeout((function() {
      div.show();
      return startCountdownBar();
    }), delta - countdownLength);
    return;
  }
  width = 100 * Math.max(0.01, 1 - delta / countdownLength);
  console.log(width);
  bar.css({
    width: "" + width + "%"
  });
  bar.animate({
    width: "100%"
  }, {
    duration: delta,
    easing: "linear"
  });
  return id = setInterval((function() {
    var min, pad, sec;
    delta = movieStart - Date.now();
    if (delta <= 0) {
      return clearInterval(id);
    } else {
      console.log(delta);
      min = Math.floor(delta / (60 * 1000));
      console.log(min);
      sec = Math.floor((delta - min * 60 * 1000) / 1000);
      pad = function(x) {
        if (x >= 10) {
          return "" + x;
        } else {
          return "0" + x;
        }
      };
      return $("#countdown-text").text("" + (pad(min)) + ":" + (pad(sec)) + " to Premiere");
    }
  }), 500);
};

startMovieCheck = function() {
  return setTimeout(startMovie, movieStart - Date.now());
};

startMovie = function() {
  transition(switchContent("/premiere/movie"), "Starting Movie", 3000);
  return setTimeout(startPostshow, movieDone - Date.now());
};

startPostshow = function() {
  return transition(switchContent("/premiere/postshow/" + userCategory));
};

$(function() {
  if (Date.now() > movieDone) {
    return startPostshow();
  } else if (Date.now() > movieStart) {
    return startMovie();
  } else {
    return setupCategory();
  }
});
